<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FIRE目標導向計算器</title>
    
    <!-- PWA設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FIRE計算器">
    
    <!-- iOS圖示 -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjAiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEw3MiA5NkgxMjBMOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNzIgMTIwSDEyMFYxNDRINzJWMTIwWiIgZmlsbD0id2hpdGUiLz4KPHN0eWxlPi5zdDB7ZmlsbDp1cmwoI2dyYWRpZW50MF9saW5lYXJfMV8xKX08L3N0eWxlPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMTkyIiB5Mj0iMTkyIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRklSReebkeaomOWwjOWQkeerpeaVuOWZqCIsInNob3J0X25hbWUiOiJGSVJF6KiI566X5ZmoIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJzdGFydF91cmwiOiIuLyIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJREU1TWlBeE9USWlJR1pwYkd3OUltNXZibVVpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhKbFkzUWdkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0k1TWlJZ2NIZzlJakl3SWlCbWFXeHNQU0oxY213b0kyZHlZV1JwWlc1ME1GOXNhVzVsWVhKZk1WOHhLU0l2UGp4d1lYUm9JR1E5SWswNU5pQTBPRXczTWlBNU5rZ3hNakJNT1RZZ05EaGFJaUJtYVd4c1BTSjNhR2wwWlNJdlBqeHdZWFJvSUdROUlrMDNNaUF4TWpCb01USTNWakUwTkVnM01sWXhNakJhSWlCbWFXeHNQU0ozYUdsMFpTSXZQand2YzNabkhqd3ZaR1ZtY3o0PSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
        }

        .input-section {
            padding: 40px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .results-section {
            padding: 40px;
            background: white;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .form-group .input-hint {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4ecdc4;
        }

        .target-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .target-main {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .target-label {
            font-size: 1.1rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4ecdc4;
            transition: transform 0.2s ease;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .result-hint {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .phases-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .phase {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .phase:last-child {
            margin-bottom: 0;
        }

        .phase-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .phase-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .phase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .phase-item:last-child {
            border-bottom: none;
        }

        .phase-label {
            font-weight: 600;
            color: #495057;
        }

        .phase-value {
            color: #6c757d;
            font-weight: 500;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .success {
            background: #d1edff;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-table th {
            background: #4ecdc4;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .phase-details {
                grid-template-columns: 1fr;
            }

            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .input-section, .results-section {
                padding: 20px;
            }
            
            .form-group input {
                padding: 15px 16px;
                font-size: 16px; /* 防止iOS縮放 */
            }
            
            .target-main {
                font-size: 2.5rem;
            }
            
            .result-value {
                font-size: 1.5rem;
            }
        }

        /* iOS特定優化 */
        @supports (-webkit-touch-callout: none) {
            .form-group input {
                -webkit-appearance: none;
                border-radius: 8px;
            }
            
            .container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 FIRE目標導向計算器</h1>
            <p>設定目標FIRE年齡，計算所需儲蓄與支出規劃</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">📊 目標設定</h2>
                
                <div class="form-group">
                    <label for="currentAge">目前年齡</label>
                    <input type="number" id="currentAge" value="30" min="18" max="65">
                    <div class="input-hint">歲</div>
                </div>

                <div class="form-group">
                    <label for="targetFireAge">目標FIRE年齡</label>
                    <input type="number" id="targetFireAge" value="47" min="30" max="80">
                    <div class="input-hint">歲</div>
                </div>

                <div class="form-group">
                    <label for="currentAssets">目前總資產</label>
                    <input type="number" id="currentAssets" value="2416879" min="0">
                    <div class="input-hint">新台幣（元）</div>
                </div>

                <div class="form-group">
                    <label for="monthlyIncome">月收入</label>
                    <input type="number" id="monthlyIncome" value="300000" min="0">
                    <div class="input-hint">新台幣（元）</div>
                </div>

                <div class="form-group">
                    <label for="postFireExpense">FIRE後期望月支出</label>
                    <input type="number" id="postFireExpense" value="200000" min="0">
                    <div class="input-hint">新台幣（元）</div>
                </div>

                <div class="form-group">
                    <label for="loanStartAge">貸款開始年齡</label>
                    <input type="number" id="loanStartAge" value="37" min="25" max="70">
                    <div class="input-hint">歲</div>
                </div>

                <div class="form-group">
                    <label for="downPayment">頭期款</label>
                    <input type="number" id="downPayment" value="3000000" min="0">
                    <div class="input-hint">新台幣（元）- 在貸款開始年齡時支付</div>
                </div>

                <div class="form-group">
                    <label for="monthlyLoan">月貸款金額</label>
                    <input type="number" id="monthlyLoan" value="84431" min="0">
                    <div class="input-hint">新台幣（元）</div>
                </div>

                <div class="form-group">
                    <label for="loanYears">貸款年限</label>
                    <input type="number" id="loanYears" value="30" min="0" max="50">
                    <div class="input-hint">年</div>
                </div>

                <div class="form-group">
                    <label for="returnRate">年投資報酬率</label>
                    <input type="number" id="returnRate" value="7" min="0" max="20" step="0.1">
                    <div class="input-hint">%</div>
                </div>

                <div class="form-group">
                    <label for="withdrawalRate">提領率</label>
                    <input type="number" id="withdrawalRate" value="4" min="2" max="8" step="0.1">
                    <div class="input-hint">%</div>
                </div>
            </div>

            <div class="results-section">
                <div class="target-card">
                    <div class="target-main" id="yearsToTarget">17</div>
                    <div class="target-label">年後達成FIRE目標</div>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-title">需要月儲蓄</div>
                        <div class="result-value" id="requiredSavings">17.5萬</div>
                        <div class="result-hint">達成目標所需</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">需要FIRE資產</div>
                        <div class="result-value" id="requiredAssets">8,533萬</div>
                        <div class="result-hint">4%提領法則</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">儲蓄率</div>
                        <div class="result-value" id="savingsRate">58%</div>
                        <div class="result-hint">收入比例</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">可支配收入</div>
                        <div class="result-value" id="availableIncome">12.5萬</div>
                        <div class="result-hint">扣除儲蓄後</div>
                    </div>
                </div>

                <div id="statusMessage"></div>

                <div class="phases-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">📅 分階段財務規劃</h3>
                    
                    <div class="phase">
                        <div class="phase-title">第一階段：貸款前累積期</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">期間</span>
                                    <span class="phase-value" id="phase1Period">30-37歲 (7年)</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月收入</span>
                                    <span class="phase-value" id="phase1Income">30萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">可用支出</span>
                                    <span class="phase-value" id="phase1Expense">12.5萬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">月儲蓄</span>
                                    <span class="phase-value" id="phase1Savings">17.5萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">儲蓄率</span>
                                    <span class="phase-value" id="phase1Rate">58%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">期末資產</span>
                                    <span class="phase-value" id="phase1EndAssets">2,205萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">頭期款支出</span>
                                    <span class="phase-value" id="phase1DownPayment">300萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">支付後資產</span>
                                    <span class="phase-value" id="phase1AfterDownPayment">1,905萬</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="phase">
                        <div class="phase-title">第二階段：有貸款期間</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">期間</span>
                                    <span class="phase-value" id="phase2Period">37-47歲 (10年)</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月收入</span>
                                    <span class="phase-value" id="phase2Income">30萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月貸款</span>
                                    <span class="phase-value" id="phase2Loan">8.4萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">可用支出</span>
                                    <span class="phase-value" id="phase2Expense">12.5萬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">月總支出</span>
                                    <span class="phase-value" id="phase2TotalExpense">20.9萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月儲蓄</span>
                                    <span class="phase-value" id="phase2Savings">9.1萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">儲蓄率</span>
                                    <span class="phase-value" id="phase2Rate">30%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">FIRE資產</span>
                                    <span class="phase-value" id="phase2EndAssets">4,266萬</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="phase">
                        <div class="phase-title">第三階段：FIRE後期間</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">開始年齡</span>
                                    <span class="phase-value" id="phase3StartAge">47歲</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月生活費</span>
                                    <span class="phase-value" id="phase3LifeExpense">20萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">月貸款</span>
                                    <span class="phase-value" id="phase3Loan">8.4萬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">月總支出</span>
                                    <span class="phase-value" id="phase3TotalExpense">28.4萬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">提領率</span>
                                    <span class="phase-value" id="phase3WithdrawalRate">4.0%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">貸款還清</span>
                                    <span class="phase-value" id="loanEndAge">67歲</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th>金額/比率</th>
                            <th>說明</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>目標FIRE年齡</td>
                            <td id="summaryFireAge">47歲</td>
                            <td>你設定的退休目標</td>
                        </tr>
                        <tr>
                            <td>需要月儲蓄</td>
                            <td id="summaryMonthlySavings">17.5萬</td>
                            <td>貸款前期間</td>
                        </tr>
                        <tr>
                            <td>可支配月支出</td>
                            <td id="summaryMonthlyExpense">12.5萬</td>
                            <td>扣除儲蓄和貸款</td>
                        </tr>
                        <tr>
                            <td>有貸款後月儲蓄</td>
                            <td id="summaryLoanPeriodSavings">9.1萬</td>
                            <td>37歲後儲蓄能力</td>
                        </tr>
                        <tr>
                            <td>FIRE時總資產</td>
                            <td id="summaryTotalAssets">4,266萬</td>
                            <td>退休時的資產</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function formatNumber(num) {
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + '億';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(0) + '萬';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + '千';
            } else {
                return Math.round(num).toLocaleString();
            }
        }

        function calculateTargetPlan() {
            try {
                // 取得輸入值
                const currentAge = parseInt(document.getElementById('currentAge').value) || 30;
                const targetFireAge = parseInt(document.getElementById('targetFireAge').value) || 47;
                const currentAssets = parseInt(document.getElementById('currentAssets').value) || 0;
                const monthlyIncome = parseInt(document.getElementById('monthlyIncome').value) || 0;
                const postFireExpense = parseInt(document.getElementById('postFireExpense').value) || 0;
                const loanStartAge = parseInt(document.getElementById('loanStartAge').value) || 37;
                const downPayment = parseInt(document.getElementById('downPayment').value) || 0;
                const monthlyLoan = parseInt(document.getElementById('monthlyLoan').value) || 0;
                const loanYears = parseInt(document.getElementById('loanYears').value) || 30;
                const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0.07;
                const withdrawalRate = parseFloat(document.getElementById('withdrawalRate').value) / 100 || 0.04;

                // 計算基本數據
                const yearsToFire = targetFireAge - currentAge;
                const yearsBeforeLoan = Math.max(0, loanStartAge - currentAge);
                const yearsWithLoan = Math.max(0, targetFireAge - loanStartAge);
                const loanEndAge = loanStartAge + loanYears;

                // 計算FIRE所需資產
                let monthlyFireExpense = postFireExpense;
                if (targetFireAge < loanEndAge) {
                    monthlyFireExpense += monthlyLoan;
                }
                const annualFireExpense = monthlyFireExpense * 12;
                const requiredFireAssets = annualFireExpense / withdrawalRate;

                // 計算需要的月儲蓄
                let requiredMonthlySavings;
                let assetsAtLoanStart;

                if (yearsBeforeLoan > 0 && yearsWithLoan > 0) {
                    // 兩階段：貸款前 + 貸款後
                    // 使用迭代方法找出最佳解
                    let bestSavings = 0;
                    let minError = Infinity;

                    for (let savings = 10000; savings <= monthlyIncome; savings += 5000) {
                        let assets = currentAssets;
                        
                        // 第一階段：累積到貸款開始年齡
                        for (let i = 0; i < yearsBeforeLoan; i++) {
                            assets = assets * (1 + returnRate) + savings * 12;
                        }
                        
                        // 支付頭期款
                        assets = assets - downPayment;
                        
                        // 第二階段：貸款期間
                        const savingsPhase2 = Math.max(0, savings - monthlyLoan);
                        for (let i = 0; i < yearsWithLoan; i++) {
                            assets = assets * (1 + returnRate) + savingsPhase2 * 12;
                        }
                        
                        const error = Math.abs(assets - requiredFireAssets);
                        if (error < minError) {
                            minError = error;
                            bestSavings = savings;
                        }
                    }
                    
                    requiredMonthlySavings = bestSavings;
                    
                    // 計算第一階段結束時的資產（支付頭期款前）
                    assetsAtLoanStart = currentAssets;
                    for (let i = 0; i < yearsBeforeLoan; i++) {
                        assetsAtLoanStart = assetsAtLoanStart * (1 + returnRate) + requiredMonthlySavings * 12;
                    }
                } else if (yearsBeforeLoan > 0) {
                    // 只有貸款前階段
                    const futureValueFactor = Math.pow(1 + returnRate, yearsBeforeLoan);
                    const annuityFactor = (futureValueFactor - 1) / returnRate;
                    // 考慮頭期款：最終需要的資產 = FIRE資產 + 頭期款
                    const totalNeeded = requiredFireAssets + downPayment;
                    requiredMonthlySavings = (totalNeeded - currentAssets * futureValueFactor) / (12 * annuityFactor);
                    assetsAtLoanStart = totalNeeded;
                } else {
                    // 只有貸款後階段（當前就開始有貸款）
                    const futureValueFactor = Math.pow(1 + returnRate, yearsWithLoan);
                    const annuityFactor = (futureValueFactor - 1) / returnRate;
                    // 立即支付頭期款
                    const startingAssets = currentAssets - downPayment;
                    const requiredMonthlySavingsAfterLoan = (requiredFireAssets - startingAssets * futureValueFactor) / (12 * annuityFactor);
                    requiredMonthlySavings = requiredMonthlySavingsAfterLoan + monthlyLoan;
                    assetsAtLoanStart = currentAssets;
                }

                // 計算最終資產驗證
                let finalAssets = currentAssets;
                if (yearsBeforeLoan > 0) {
                    // 第一階段累積
                    for (let i = 0; i < yearsBeforeLoan; i++) {
                        finalAssets = finalAssets * (1 + returnRate) + requiredMonthlySavings * 12;
                    }
                    // 支付頭期款
                    finalAssets = finalAssets - downPayment;
                } else {
                    // 立即支付頭期款
                    finalAssets = finalAssets - downPayment;
                }
                
                if (yearsWithLoan > 0) {
                    // 第二階段累積
                    const savingsAfterLoan = requiredMonthlySavings - monthlyLoan;
                    for (let i = 0; i < yearsWithLoan; i++) {
                        finalAssets = finalAssets * (1 + returnRate) + savingsAfterLoan * 12;
                    }
                }

                // 計算各項指標
                const savingsRate = (requiredMonthlySavings / monthlyIncome) * 100;
                const availableExpense = monthlyIncome - requiredMonthlySavings;
                const savingsAfterLoan = requiredMonthlySavings - monthlyLoan;
                const savingsRateAfterLoan = (savingsAfterLoan / monthlyIncome) * 100;
                const availableExpenseAfterLoan = monthlyIncome - savingsAfterLoan - monthlyLoan;

                // 更新顯示
                updateResults({
                    yearsToFire,
                    requiredMonthlySavings,
                    requiredFireAssets,
                    savingsRate,
                    availableExpense,
                    currentAge,
                    targetFireAge,
                    loanStartAge,
                    monthlyIncome,
                    monthlyLoan,
                    yearsBeforeLoan,
                    yearsWithLoan,
                    assetsAtLoanStart,
                    finalAssets,
                    savingsAfterLoan,
                    savingsRateAfterLoan,
                    availableExpenseAfterLoan,
                    postFireExpense,
                    loanEndAge,
                    withdrawalRate,
                    downPayment
                });

                // 更新狀態訊息
                updateStatusMessage(requiredMonthlySavings, monthlyIncome, savingsRate, availableExpense, assetsAtLoanStart, downPayment);

            } catch (error) {
                console.error('計算錯誤:', error);
                document.getElementById('statusMessage').innerHTML = 
                    '<div class="error">計算發生錯誤，請檢查輸入數值</div>';
            }
        }

        function updateResults(data) {
            // 主要結果
            document.getElementById('yearsToTarget').textContent = data.yearsToFire;
            document.getElementById('requiredSavings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('requiredAssets').textContent = formatNumber(data.requiredFireAssets);
            document.getElementById('savingsRate').textContent = Math.round(data.savingsRate) + '%';
            document.getElementById('availableIncome').textContent = formatNumber(data.availableExpense);

            // 第一階段
            document.getElementById('phase1Period').textContent = 
                `${data.currentAge}-${data.loanStartAge}歲 (${data.yearsBeforeLoan}年)`;
            document.getElementById('phase1Income').textContent = formatNumber(data.monthlyIncome);
            document.getElementById('phase1Expense').textContent = formatNumber(data.availableExpense);
            document.getElementById('phase1Savings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('phase1Rate').textContent = Math.round(data.savingsRate) + '%';
            document.getElementById('phase1EndAssets').textContent = formatNumber(data.assetsAtLoanStart);
            document.getElementById('phase1DownPayment').textContent = formatNumber(data.downPayment);
            document.getElementById('phase1AfterDownPayment').textContent = formatNumber(data.assetsAtLoanStart - data.downPayment);

            // 第二階段
            document.getElementById('phase2Period').textContent = 
                `${data.loanStartAge}-${data.targetFireAge}歲 (${data.yearsWithLoan}年)`;
            document.getElementById('phase2Income').textContent = formatNumber(data.monthlyIncome);
            document.getElementById('phase2Loan').textContent = formatNumber(data.monthlyLoan);
            document.getElementById('phase2Expense').textContent = formatNumber(data.availableExpenseAfterLoan);
            document.getElementById('phase2TotalExpense').textContent = formatNumber(data.availableExpenseAfterLoan + data.monthlyLoan);
            document.getElementById('phase2Savings').textContent = formatNumber(data.savingsAfterLoan);
            document.getElementById('phase2Rate').textContent = Math.round(data.savingsRateAfterLoan) + '%';
            document.getElementById('phase2EndAssets').textContent = formatNumber(data.finalAssets);

            // 第三階段
            document.getElementById('phase3StartAge').textContent = data.targetFireAge + '歲';
            document.getElementById('phase3LifeExpense').textContent = formatNumber(data.postFireExpense);
            document.getElementById('phase3Loan').textContent = formatNumber(data.monthlyLoan);
            document.getElementById('phase3TotalExpense').textContent = formatNumber(data.postFireExpense + data.monthlyLoan);
            document.getElementById('phase3WithdrawalRate').textContent = (data.withdrawalRate * 100).toFixed(1) + '%';
            document.getElementById('loanEndAge').textContent = data.loanEndAge + '歲';

            // 摘要表格
            document.getElementById('summaryFireAge').textContent = data.targetFireAge + '歲';
            document.getElementById('summaryMonthlySavings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('summaryMonthlyExpense').textContent = formatNumber(data.availableExpense);
            document.getElementById('summaryLoanPeriodSavings').textContent = formatNumber(data.savingsAfterLoan);
            document.getElementById('summaryTotalAssets').textContent = formatNumber(data.finalAssets);
        }

        function updateStatusMessage(requiredSavings, monthlyIncome, savingsRate, availableExpense, assetsAtLoanStart, downPayment) {
            const statusDiv = document.getElementById('statusMessage');
            let message = '';

            if (requiredSavings > monthlyIncome) {
                message = '<div class="error">⚠️ 警告：所需儲蓄超過月收入！請調整目標年齡或增加收入。</div>';
            } else if (assetsAtLoanStart < downPayment) {
                message = '<div class="error">⚠️ 警告：到貸款開始年齡時資產不足以支付頭期款！請增加儲蓄或減少頭期款。</div>';
            } else if (savingsRate > 70) {
                message = '<div class="warning">⚠️ 注意：儲蓄率超過70%，生活品質可能受影響。</div>';
            } else if (availableExpense < 50000) {
                message = '<div class="warning">⚠️ 注意：可支配支出較低，請確認是否可行。</div>';
            } else if (savingsRate >= 50) {
                message = '<div class="warning">💪 高儲蓄率計畫！需要很強的自制力。</div>';
            } else {
                message = '<div class="success">✅ 財務規劃看起來合理可行！</div>';
            }

            statusDiv.innerHTML = message;
        }

        // 添加事件監聽器
        function setupEventListeners() {
            const inputs = [
                'currentAge', 'targetFireAge', 'currentAssets', 'monthlyIncome',
                'postFireExpense', 'loanStartAge', 'downPayment', 'monthlyLoan', 'loanYears',
                'returnRate', 'withdrawalRate'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateTargetPlan);
                    element.addEventListener('change', calculateTargetPlan);
                }
            });
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            calculateTargetPlan(); // 初始計算
        });
    </script>
</body>
</html>
