<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FIREç›®æ¨™å°å‘è¨ˆç®—å™¨</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="FIREè¨ˆç®—å™¨">
    
    <!-- iOSåœ–ç¤º -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjAiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik05NiA0OEw3MiA5NkgxMjBMOTYgNDhaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNzIgMTIwSDEyMFYxNDRINzJWMTIwWiIgZmlsbD0id2hpdGUiLz4KPHN0eWxlPi5zdDB7ZmlsbDp1cmwoI2dyYWRpZW50MF9saW5lYXJfMV8xKX08L3N0eWxlPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMTkyIiB5Mj0iMTkyIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+">
    
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRklSReebkeaomOWwjOWQkeerpeaVuOWZqCIsInNob3J0X25hbWUiOiJGSVJF6KiI566X5ZmoIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJzdGFydF91cmwiOiIuLyIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1Ua3lJaUJvWldsbmFIUTlJakU1TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJREU1TWlBeE9USWlJR1pwYkd3OUltNXZibVVpSUhodGJHNXpQU0pvZEhSd09pOHZkM2QzTG5jekxtOXlaeTh5TURBd0wzTjJaeUkrUEhKbFkzUWdkMmxrZEdnOUlqRTVNaUlnYUdWcFoyaDBQU0k1TWlJZ2NIZzlJakl3SWlCbWFXeHNQU0oxY213b0kyZHlZV1JwWlc1ME1GOXNhVzVsWVhKZk1WOHhLU0l2UGp4d1lYUm9JR1E5SWswNU5pQTBPRXczTWlBNU5rZ3hNakJNT1RZZ05EaGFJaUJtYVd4c1BTSjNhR2wwWlNJdlBqeHdZWFJvSUdROUlrMDNNaUF4TWpCb01USTNWakUwTkVnM01sWXhNakJhSWlCbWFXeHNQU0ozYUdsMFpTSXZQand2YzNabkhqd3ZaR1ZtY3o0PSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 0;
        }

        .input-section {
            padding: 40px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .results-section {
            padding: 40px;
            background: white;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }

        .form-group .input-hint {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 4px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4ecdc4;
        }

        .target-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .target-main {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .target-label {
            font-size: 1.1rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #4ecdc4;
            transition: transform 0.2s ease;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .result-hint {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .phases-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .phase {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #ff6b6b;
        }

        .phase:last-child {
            margin-bottom: 0;
        }

        .phase-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .phase-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .phase-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .phase-item:last-child {
            border-bottom: none;
        }

        .phase-label {
            font-weight: 600;
            color: #495057;
        }

        .phase-value {
            color: #6c757d;
            font-weight: 500;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .success {
            background: #d1edff;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-table th {
            background: #4ecdc4;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .phase-details {
                grid-template-columns: 1fr;
            }

            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .input-section, .results-section {
                padding: 20px;
            }
            
            .form-group input {
                padding: 15px 16px;
                font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
            }
            
            .target-main {
                font-size: 2.5rem;
            }
            
            .result-value {
                font-size: 1.5rem;
            }
        }

        /* iOSç‰¹å®šå„ªåŒ– */
        @supports (-webkit-touch-callout: none) {
            .form-group input {
                -webkit-appearance: none;
                border-radius: 8px;
            }
            
            .container {
                -webkit-overflow-scrolling: touch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ FIREç›®æ¨™å°å‘è¨ˆç®—å™¨</h1>
            <p>è¨­å®šç›®æ¨™FIREå¹´é½¡ï¼Œè¨ˆç®—æ‰€éœ€å„²è“„èˆ‡æ”¯å‡ºè¦åŠƒ</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">ğŸ“Š ç›®æ¨™è¨­å®š</h2>
                
                <div class="form-group">
                    <label for="currentAge">ç›®å‰å¹´é½¡</label>
                    <input type="number" id="currentAge" value="30" min="18" max="65">
                    <div class="input-hint">æ­²</div>
                </div>

                <div class="form-group">
                    <label for="targetFireAge">ç›®æ¨™FIREå¹´é½¡</label>
                    <input type="number" id="targetFireAge" value="47" min="30" max="80">
                    <div class="input-hint">æ­²</div>
                </div>

                <div class="form-group">
                    <label for="currentAssets">ç›®å‰ç¸½è³‡ç”¢</label>
                    <input type="number" id="currentAssets" value="2416879" min="0">
                    <div class="input-hint">æ–°å°å¹£ï¼ˆå…ƒï¼‰</div>
                </div>

                <div class="form-group">
                    <label for="monthlyIncome">æœˆæ”¶å…¥</label>
                    <input type="number" id="monthlyIncome" value="300000" min="0">
                    <div class="input-hint">æ–°å°å¹£ï¼ˆå…ƒï¼‰</div>
                </div>

                <div class="form-group">
                    <label for="postFireExpense">FIREå¾ŒæœŸæœ›æœˆæ”¯å‡º</label>
                    <input type="number" id="postFireExpense" value="200000" min="0">
                    <div class="input-hint">æ–°å°å¹£ï¼ˆå…ƒï¼‰</div>
                </div>

                <div class="form-group">
                    <label for="loanStartAge">è²¸æ¬¾é–‹å§‹å¹´é½¡</label>
                    <input type="number" id="loanStartAge" value="37" min="25" max="70">
                    <div class="input-hint">æ­²</div>
                </div>

                <div class="form-group">
                    <label for="downPayment">é ­æœŸæ¬¾</label>
                    <input type="number" id="downPayment" value="3000000" min="0">
                    <div class="input-hint">æ–°å°å¹£ï¼ˆå…ƒï¼‰- åœ¨è²¸æ¬¾é–‹å§‹å¹´é½¡æ™‚æ”¯ä»˜</div>
                </div>

                <div class="form-group">
                    <label for="monthlyLoan">æœˆè²¸æ¬¾é‡‘é¡</label>
                    <input type="number" id="monthlyLoan" value="84431" min="0">
                    <div class="input-hint">æ–°å°å¹£ï¼ˆå…ƒï¼‰</div>
                </div>

                <div class="form-group">
                    <label for="loanYears">è²¸æ¬¾å¹´é™</label>
                    <input type="number" id="loanYears" value="30" min="0" max="50">
                    <div class="input-hint">å¹´</div>
                </div>

                <div class="form-group">
                    <label for="returnRate">å¹´æŠ•è³‡å ±é…¬ç‡</label>
                    <input type="number" id="returnRate" value="7" min="0" max="20" step="0.1">
                    <div class="input-hint">%</div>
                </div>

                <div class="form-group">
                    <label for="withdrawalRate">æé ˜ç‡</label>
                    <input type="number" id="withdrawalRate" value="4" min="2" max="8" step="0.1">
                    <div class="input-hint">%</div>
                </div>
            </div>

            <div class="results-section">
                <div class="target-card">
                    <div class="target-main" id="yearsToTarget">17</div>
                    <div class="target-label">å¹´å¾Œé”æˆFIREç›®æ¨™</div>
                </div>

                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-title">éœ€è¦æœˆå„²è“„</div>
                        <div class="result-value" id="requiredSavings">17.5è¬</div>
                        <div class="result-hint">é”æˆç›®æ¨™æ‰€éœ€</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">éœ€è¦FIREè³‡ç”¢</div>
                        <div class="result-value" id="requiredAssets">8,533è¬</div>
                        <div class="result-hint">4%æé ˜æ³•å‰‡</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">å„²è“„ç‡</div>
                        <div class="result-value" id="savingsRate">58%</div>
                        <div class="result-hint">æ”¶å…¥æ¯”ä¾‹</div>
                    </div>
                    <div class="result-card">
                        <div class="result-title">å¯æ”¯é…æ”¶å…¥</div>
                        <div class="result-value" id="availableIncome">12.5è¬</div>
                        <div class="result-hint">æ‰£é™¤å„²è“„å¾Œ</div>
                    </div>
                </div>

                <div id="statusMessage"></div>

                <div class="phases-section">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“… åˆ†éšæ®µè²¡å‹™è¦åŠƒ</h3>
                    
                    <div class="phase">
                        <div class="phase-title">ç¬¬ä¸€éšæ®µï¼šè²¸æ¬¾å‰ç´¯ç©æœŸ</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">æœŸé–“</span>
                                    <span class="phase-value" id="phase1Period">30-37æ­² (7å¹´)</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆæ”¶å…¥</span>
                                    <span class="phase-value" id="phase1Income">30è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">å¯ç”¨æ”¯å‡º</span>
                                    <span class="phase-value" id="phase1Expense">12.5è¬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆå„²è“„</span>
                                    <span class="phase-value" id="phase1Savings">17.5è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">å„²è“„ç‡</span>
                                    <span class="phase-value" id="phase1Rate">58%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœŸæœ«è³‡ç”¢</span>
                                    <span class="phase-value" id="phase1EndAssets">2,205è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">é ­æœŸæ¬¾æ”¯å‡º</span>
                                    <span class="phase-value" id="phase1DownPayment">300è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æ”¯ä»˜å¾Œè³‡ç”¢</span>
                                    <span class="phase-value" id="phase1AfterDownPayment">1,905è¬</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="phase">
                        <div class="phase-title">ç¬¬äºŒéšæ®µï¼šæœ‰è²¸æ¬¾æœŸé–“</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">æœŸé–“</span>
                                    <span class="phase-value" id="phase2Period">37-47æ­² (10å¹´)</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆæ”¶å…¥</span>
                                    <span class="phase-value" id="phase2Income">30è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆè²¸æ¬¾</span>
                                    <span class="phase-value" id="phase2Loan">8.4è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">å¯ç”¨æ”¯å‡º</span>
                                    <span class="phase-value" id="phase2Expense">12.5è¬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆç¸½æ”¯å‡º</span>
                                    <span class="phase-value" id="phase2TotalExpense">20.9è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆå„²è“„</span>
                                    <span class="phase-value" id="phase2Savings">9.1è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">å„²è“„ç‡</span>
                                    <span class="phase-value" id="phase2Rate">30%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">FIREè³‡ç”¢</span>
                                    <span class="phase-value" id="phase2EndAssets">4,266è¬</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="phase">
                        <div class="phase-title">ç¬¬ä¸‰éšæ®µï¼šFIREå¾ŒæœŸé–“</div>
                        <div class="phase-details">
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">é–‹å§‹å¹´é½¡</span>
                                    <span class="phase-value" id="phase3StartAge">47æ­²</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆç”Ÿæ´»è²»</span>
                                    <span class="phase-value" id="phase3LifeExpense">20è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆè²¸æ¬¾</span>
                                    <span class="phase-value" id="phase3Loan">8.4è¬</span>
                                </div>
                            </div>
                            <div>
                                <div class="phase-item">
                                    <span class="phase-label">æœˆç¸½æ”¯å‡º</span>
                                    <span class="phase-value" id="phase3TotalExpense">28.4è¬</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">æé ˜ç‡</span>
                                    <span class="phase-value" id="phase3WithdrawalRate">4.0%</span>
                                </div>
                                <div class="phase-item">
                                    <span class="phase-label">è²¸æ¬¾é‚„æ¸…</span>
                                    <span class="phase-value" id="loanEndAge">67æ­²</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>é …ç›®</th>
                            <th>é‡‘é¡/æ¯”ç‡</th>
                            <th>èªªæ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ç›®æ¨™FIREå¹´é½¡</td>
                            <td id="summaryFireAge">47æ­²</td>
                            <td>ä½ è¨­å®šçš„é€€ä¼‘ç›®æ¨™</td>
                        </tr>
                        <tr>
                            <td>éœ€è¦æœˆå„²è“„</td>
                            <td id="summaryMonthlySavings">17.5è¬</td>
                            <td>è²¸æ¬¾å‰æœŸé–“</td>
                        </tr>
                        <tr>
                            <td>å¯æ”¯é…æœˆæ”¯å‡º</td>
                            <td id="summaryMonthlyExpense">12.5è¬</td>
                            <td>æ‰£é™¤å„²è“„å’Œè²¸æ¬¾</td>
                        </tr>
                        <tr>
                            <td>æœ‰è²¸æ¬¾å¾Œæœˆå„²è“„</td>
                            <td id="summaryLoanPeriodSavings">9.1è¬</td>
                            <td>37æ­²å¾Œå„²è“„èƒ½åŠ›</td>
                        </tr>
                        <tr>
                            <td>FIREæ™‚ç¸½è³‡ç”¢</td>
                            <td id="summaryTotalAssets">4,266è¬</td>
                            <td>é€€ä¼‘æ™‚çš„è³‡ç”¢</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function formatNumber(num) {
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + 'å„„';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(0) + 'è¬';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'åƒ';
            } else {
                return Math.round(num).toLocaleString();
            }
        }

        function calculateTargetPlan() {
            try {
                // å–å¾—è¼¸å…¥å€¼
                const currentAge = parseInt(document.getElementById('currentAge').value) || 30;
                const targetFireAge = parseInt(document.getElementById('targetFireAge').value) || 47;
                const currentAssets = parseInt(document.getElementById('currentAssets').value) || 0;
                const monthlyIncome = parseInt(document.getElementById('monthlyIncome').value) || 0;
                const postFireExpense = parseInt(document.getElementById('postFireExpense').value) || 0;
                const loanStartAge = parseInt(document.getElementById('loanStartAge').value) || 37;
                const downPayment = parseInt(document.getElementById('downPayment').value) || 0;
                const monthlyLoan = parseInt(document.getElementById('monthlyLoan').value) || 0;
                const loanYears = parseInt(document.getElementById('loanYears').value) || 30;
                const returnRate = parseFloat(document.getElementById('returnRate').value) / 100 || 0.07;
                const withdrawalRate = parseFloat(document.getElementById('withdrawalRate').value) / 100 || 0.04;

                // è¨ˆç®—åŸºæœ¬æ•¸æ“š
                const yearsToFire = targetFireAge - currentAge;
                const yearsBeforeLoan = Math.max(0, loanStartAge - currentAge);
                const yearsWithLoan = Math.max(0, targetFireAge - loanStartAge);
                const loanEndAge = loanStartAge + loanYears;

                // è¨ˆç®—FIREæ‰€éœ€è³‡ç”¢
                let monthlyFireExpense = postFireExpense;
                if (targetFireAge < loanEndAge) {
                    monthlyFireExpense += monthlyLoan;
                }
                const annualFireExpense = monthlyFireExpense * 12;
                const requiredFireAssets = annualFireExpense / withdrawalRate;

                // è¨ˆç®—éœ€è¦çš„æœˆå„²è“„
                let requiredMonthlySavings;
                let assetsAtLoanStart;

                if (yearsBeforeLoan > 0 && yearsWithLoan > 0) {
                    // å…©éšæ®µï¼šè²¸æ¬¾å‰ + è²¸æ¬¾å¾Œ
                    // ä½¿ç”¨è¿­ä»£æ–¹æ³•æ‰¾å‡ºæœ€ä½³è§£
                    let bestSavings = 0;
                    let minError = Infinity;

                    for (let savings = 10000; savings <= monthlyIncome; savings += 5000) {
                        let assets = currentAssets;
                        
                        // ç¬¬ä¸€éšæ®µï¼šç´¯ç©åˆ°è²¸æ¬¾é–‹å§‹å¹´é½¡
                        for (let i = 0; i < yearsBeforeLoan; i++) {
                            assets = assets * (1 + returnRate) + savings * 12;
                        }
                        
                        // æ”¯ä»˜é ­æœŸæ¬¾
                        assets = assets - downPayment;
                        
                        // ç¬¬äºŒéšæ®µï¼šè²¸æ¬¾æœŸé–“
                        const savingsPhase2 = Math.max(0, savings - monthlyLoan);
                        for (let i = 0; i < yearsWithLoan; i++) {
                            assets = assets * (1 + returnRate) + savingsPhase2 * 12;
                        }
                        
                        const error = Math.abs(assets - requiredFireAssets);
                        if (error < minError) {
                            minError = error;
                            bestSavings = savings;
                        }
                    }
                    
                    requiredMonthlySavings = bestSavings;
                    
                    // è¨ˆç®—ç¬¬ä¸€éšæ®µçµæŸæ™‚çš„è³‡ç”¢ï¼ˆæ”¯ä»˜é ­æœŸæ¬¾å‰ï¼‰
                    assetsAtLoanStart = currentAssets;
                    for (let i = 0; i < yearsBeforeLoan; i++) {
                        assetsAtLoanStart = assetsAtLoanStart * (1 + returnRate) + requiredMonthlySavings * 12;
                    }
                } else if (yearsBeforeLoan > 0) {
                    // åªæœ‰è²¸æ¬¾å‰éšæ®µ
                    const futureValueFactor = Math.pow(1 + returnRate, yearsBeforeLoan);
                    const annuityFactor = (futureValueFactor - 1) / returnRate;
                    // è€ƒæ…®é ­æœŸæ¬¾ï¼šæœ€çµ‚éœ€è¦çš„è³‡ç”¢ = FIREè³‡ç”¢ + é ­æœŸæ¬¾
                    const totalNeeded = requiredFireAssets + downPayment;
                    requiredMonthlySavings = (totalNeeded - currentAssets * futureValueFactor) / (12 * annuityFactor);
                    assetsAtLoanStart = totalNeeded;
                } else {
                    // åªæœ‰è²¸æ¬¾å¾Œéšæ®µï¼ˆç•¶å‰å°±é–‹å§‹æœ‰è²¸æ¬¾ï¼‰
                    const futureValueFactor = Math.pow(1 + returnRate, yearsWithLoan);
                    const annuityFactor = (futureValueFactor - 1) / returnRate;
                    // ç«‹å³æ”¯ä»˜é ­æœŸæ¬¾
                    const startingAssets = currentAssets - downPayment;
                    const requiredMonthlySavingsAfterLoan = (requiredFireAssets - startingAssets * futureValueFactor) / (12 * annuityFactor);
                    requiredMonthlySavings = requiredMonthlySavingsAfterLoan + monthlyLoan;
                    assetsAtLoanStart = currentAssets;
                }

                // è¨ˆç®—æœ€çµ‚è³‡ç”¢é©—è­‰
                let finalAssets = currentAssets;
                if (yearsBeforeLoan > 0) {
                    // ç¬¬ä¸€éšæ®µç´¯ç©
                    for (let i = 0; i < yearsBeforeLoan; i++) {
                        finalAssets = finalAssets * (1 + returnRate) + requiredMonthlySavings * 12;
                    }
                    // æ”¯ä»˜é ­æœŸæ¬¾
                    finalAssets = finalAssets - downPayment;
                } else {
                    // ç«‹å³æ”¯ä»˜é ­æœŸæ¬¾
                    finalAssets = finalAssets - downPayment;
                }
                
                if (yearsWithLoan > 0) {
                    // ç¬¬äºŒéšæ®µç´¯ç©
                    const savingsAfterLoan = requiredMonthlySavings - monthlyLoan;
                    for (let i = 0; i < yearsWithLoan; i++) {
                        finalAssets = finalAssets * (1 + returnRate) + savingsAfterLoan * 12;
                    }
                }

                // è¨ˆç®—å„é …æŒ‡æ¨™
                const savingsRate = (requiredMonthlySavings / monthlyIncome) * 100;
                const availableExpense = monthlyIncome - requiredMonthlySavings;
                const savingsAfterLoan = requiredMonthlySavings - monthlyLoan;
                const savingsRateAfterLoan = (savingsAfterLoan / monthlyIncome) * 100;
                const availableExpenseAfterLoan = monthlyIncome - savingsAfterLoan - monthlyLoan;

                // æ›´æ–°é¡¯ç¤º
                updateResults({
                    yearsToFire,
                    requiredMonthlySavings,
                    requiredFireAssets,
                    savingsRate,
                    availableExpense,
                    currentAge,
                    targetFireAge,
                    loanStartAge,
                    monthlyIncome,
                    monthlyLoan,
                    yearsBeforeLoan,
                    yearsWithLoan,
                    assetsAtLoanStart,
                    finalAssets,
                    savingsAfterLoan,
                    savingsRateAfterLoan,
                    availableExpenseAfterLoan,
                    postFireExpense,
                    loanEndAge,
                    withdrawalRate,
                    downPayment
                });

                // æ›´æ–°ç‹€æ…‹è¨Šæ¯
                updateStatusMessage(requiredMonthlySavings, monthlyIncome, savingsRate, availableExpense, assetsAtLoanStart, downPayment);

            } catch (error) {
                console.error('è¨ˆç®—éŒ¯èª¤:', error);
                document.getElementById('statusMessage').innerHTML = 
                    '<div class="error">è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ•¸å€¼</div>';
            }
        }

        function updateResults(data) {
            // ä¸»è¦çµæœ
            document.getElementById('yearsToTarget').textContent = data.yearsToFire;
            document.getElementById('requiredSavings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('requiredAssets').textContent = formatNumber(data.requiredFireAssets);
            document.getElementById('savingsRate').textContent = Math.round(data.savingsRate) + '%';
            document.getElementById('availableIncome').textContent = formatNumber(data.availableExpense);

            // ç¬¬ä¸€éšæ®µ
            document.getElementById('phase1Period').textContent = 
                `${data.currentAge}-${data.loanStartAge}æ­² (${data.yearsBeforeLoan}å¹´)`;
            document.getElementById('phase1Income').textContent = formatNumber(data.monthlyIncome);
            document.getElementById('phase1Expense').textContent = formatNumber(data.availableExpense);
            document.getElementById('phase1Savings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('phase1Rate').textContent = Math.round(data.savingsRate) + '%';
            document.getElementById('phase1EndAssets').textContent = formatNumber(data.assetsAtLoanStart);
            document.getElementById('phase1DownPayment').textContent = formatNumber(data.downPayment);
            document.getElementById('phase1AfterDownPayment').textContent = formatNumber(data.assetsAtLoanStart - data.downPayment);

            // ç¬¬äºŒéšæ®µ
            document.getElementById('phase2Period').textContent = 
                `${data.loanStartAge}-${data.targetFireAge}æ­² (${data.yearsWithLoan}å¹´)`;
            document.getElementById('phase2Income').textContent = formatNumber(data.monthlyIncome);
            document.getElementById('phase2Loan').textContent = formatNumber(data.monthlyLoan);
            document.getElementById('phase2Expense').textContent = formatNumber(data.availableExpenseAfterLoan);
            document.getElementById('phase2TotalExpense').textContent = formatNumber(data.availableExpenseAfterLoan + data.monthlyLoan);
            document.getElementById('phase2Savings').textContent = formatNumber(data.savingsAfterLoan);
            document.getElementById('phase2Rate').textContent = Math.round(data.savingsRateAfterLoan) + '%';
            document.getElementById('phase2EndAssets').textContent = formatNumber(data.finalAssets);

            // ç¬¬ä¸‰éšæ®µ
            document.getElementById('phase3StartAge').textContent = data.targetFireAge + 'æ­²';
            document.getElementById('phase3LifeExpense').textContent = formatNumber(data.postFireExpense);
            document.getElementById('phase3Loan').textContent = formatNumber(data.monthlyLoan);
            document.getElementById('phase3TotalExpense').textContent = formatNumber(data.postFireExpense + data.monthlyLoan);
            document.getElementById('phase3WithdrawalRate').textContent = (data.withdrawalRate * 100).toFixed(1) + '%';
            document.getElementById('loanEndAge').textContent = data.loanEndAge + 'æ­²';

            // æ‘˜è¦è¡¨æ ¼
            document.getElementById('summaryFireAge').textContent = data.targetFireAge + 'æ­²';
            document.getElementById('summaryMonthlySavings').textContent = formatNumber(data.requiredMonthlySavings);
            document.getElementById('summaryMonthlyExpense').textContent = formatNumber(data.availableExpense);
            document.getElementById('summaryLoanPeriodSavings').textContent = formatNumber(data.savingsAfterLoan);
            document.getElementById('summaryTotalAssets').textContent = formatNumber(data.finalAssets);
        }

        function updateStatusMessage(requiredSavings, monthlyIncome, savingsRate, availableExpense, assetsAtLoanStart, downPayment) {
            const statusDiv = document.getElementById('statusMessage');
            let message = '';

            if (requiredSavings > monthlyIncome) {
                message = '<div class="error">âš ï¸ è­¦å‘Šï¼šæ‰€éœ€å„²è“„è¶…éæœˆæ”¶å…¥ï¼è«‹èª¿æ•´ç›®æ¨™å¹´é½¡æˆ–å¢åŠ æ”¶å…¥ã€‚</div>';
            } else if (assetsAtLoanStart < downPayment) {
                message = '<div class="error">âš ï¸ è­¦å‘Šï¼šåˆ°è²¸æ¬¾é–‹å§‹å¹´é½¡æ™‚è³‡ç”¢ä¸è¶³ä»¥æ”¯ä»˜é ­æœŸæ¬¾ï¼è«‹å¢åŠ å„²è“„æˆ–æ¸›å°‘é ­æœŸæ¬¾ã€‚</div>';
            } else if (savingsRate > 70) {
                message = '<div class="warning">âš ï¸ æ³¨æ„ï¼šå„²è“„ç‡è¶…é70%ï¼Œç”Ÿæ´»å“è³ªå¯èƒ½å—å½±éŸ¿ã€‚</div>';
            } else if (availableExpense < 50000) {
                message = '<div class="warning">âš ï¸ æ³¨æ„ï¼šå¯æ”¯é…æ”¯å‡ºè¼ƒä½ï¼Œè«‹ç¢ºèªæ˜¯å¦å¯è¡Œã€‚</div>';
            } else if (savingsRate >= 50) {
                message = '<div class="warning">ğŸ’ª é«˜å„²è“„ç‡è¨ˆç•«ï¼éœ€è¦å¾ˆå¼·çš„è‡ªåˆ¶åŠ›ã€‚</div>';
            } else {
                message = '<div class="success">âœ… è²¡å‹™è¦åŠƒçœ‹èµ·ä¾†åˆç†å¯è¡Œï¼</div>';
            }

            statusDiv.innerHTML = message;
        }

        // æ·»åŠ äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            const inputs = [
                'currentAge', 'targetFireAge', 'currentAssets', 'monthlyIncome',
                'postFireExpense', 'loanStartAge', 'downPayment', 'monthlyLoan', 'loanYears',
                'returnRate', 'withdrawalRate'
            ];

            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateTargetPlan);
                    element.addEventListener('change', calculateTargetPlan);
                }
            });
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            calculateTargetPlan(); // åˆå§‹è¨ˆç®—
        });
    </script>
</body>
</html>
